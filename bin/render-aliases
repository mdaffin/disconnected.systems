#!/usr/bin/env node
const path = require('path')
const url = require('url')
const fs = require('fs-extra')

function aliasOutPath(outDir, alias) {
    const outFilePath = path.resolve(outDir, alias.replace(/^\//, ''))
    if (!outFilePath.endsWith('.html')) {
        return path.resolve(outFilePath, 'index.html')
    }
    return outFilePath
}

function renderAlias(source) {
    return `<!DOCTYPE html><html><head><title>${source}</title><link rel="canonical" href="${source}"/><meta name="robots" content="noindex"><meta http-equiv="content-type" content="text/html; charset=utf-8" /><meta http-equiv="refresh" content="0; url=${source}" /></head></html>`
}

async function writeAlias(outDir, alias, source) {
    const outFilePath = aliasOutPath(outDir, alias)
    await fs.mkdirs(path.dirname(outFilePath))
    await fs.writeFile(outFilePath, renderAlias(source))
}

async function main() {
    const prepare = require('../node_modules/vuepress/lib/prepare')
    const options = await prepare('site')
    const outDir = options.outDir

    for (page of options.siteData.pages) {
        const aliases = page.frontmatter.aliases

        if (aliases) {
            for (alias of aliases) {
                const to = url.resolve(options.siteData.base, page.path)
                console.log(`Creating alias ${alias} => ${to}`)
                await writeAlias(outDir, alias, to)
            }
        }
    }
};

main();
